{% block body %}
<head>
</head>
    <h2>Counter</h2>
    {% if swears %}
    <p>Swears: {{swears}}</p>
    {% endif %}
    </ul>

    <button id="requestMicButton">Request Microphone Access</button>
    <button id="stop">Stop</button>

    <script>
        const requestMicButton = document.getElementById('requestMicButton');
        const stopButton = document.getElementById('stop');
        let mediaRecorder;
        let chunks = [];

        // Event listener for requesting microphone access
        requestMicButton.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);

                // Handle data available from the media recorder
                mediaRecorder.ondataavailable = (e) => {
                    chunks.push(e.data);
                };
                mediaRecorder.start();
                let track = stream.getAudioTracks()[0];
                console.log(track.getCapabilities());

                console.log(mediaRecorder.state);

                intervalCount = setInterval(() => {
                    if(mediaRecorder.state == 'recording'){
                        mediaRecorder.stop();
                    }
                }, 10000) 

                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    chunks = [];
                    
                    const formData = new FormData();
                    formData.append('audio', blob, 'recording.webm');

                    fetch('/upload', {
                        method: 'POST',
                        body: formData
                    }).then(response => console.log(response))

                    mediaRecorder.start();
                }
            } catch (err) {
                console.error('Error accessing microphone:', err);
            }
        });

        // Event listener for stopping the recording
        stopButton.addEventListener('click', () => {
            if (mediaRecorder) {
                clearInterval(intervalCount);
                mediaRecorder.stop();
                
                mediaRecorder.onstop = () => {
                    console.log(mediaRecorder.state)
                };
            }
        });
    </script>
{% endblock %}
